#!/bin/bash

# Read stdin to get the hook payload
input=$(cat)

# Use python3 to parse the JSON and return:
# Line 1: 0 or 1 (should notify)
# Line 2: The project/directory name (if notify=1)
output=$(echo "$input" | python3 -c "
import sys, json, os

try:
    data = json.load(sys.stdin)
    ntype = data.get('notification_type', '')
    event = data.get('hook_event_name', '')
    cwd = data.get('cwd', '')
    
    # Get just the directory name (e.g., 'dotfiles')
    project_name = os.path.basename(cwd) if cwd else 'Gemini'
    
    msg = ntype if ntype else 'Agent Finished'
    if event == 'Notification' and ntype == 'InputRequired':
        msg = 'Input Required'
    
    should_notify = False
    
    # 1. Notify on explicit system notifications
    if event == 'Notification' and ntype in ['ToolPermission', 'InputRequired', 'IdleAlert']:
        should_notify = True

    # 2. Notify when the agent is done
    elif event == 'AfterAgent':
        should_notify = True
        
    print('1' if should_notify else '0')
    print(project_name)
    print(msg)
    print(cwd)

except Exception:
    print('0')
    print('Gemini')
    print('Task Finished')
    print('')
")

should_notify=$(echo "$output" | sed -n '1p')
project_name=$(echo "$output" | sed -n '2p')
message=$(echo "$output" | sed -n '3p')
full_cwd=$(echo "$output" | sed -n '4p')

if [ "$should_notify" == "1" ]; then
    SCRIPT_DIR=$(dirname "$0")
    # Title: Gemini (dotfiles)
    # Message: ToolPermission | /path/to/project
    "$SCRIPT_DIR/notify" "$message" "Gemini ($project_name)" "$full_cwd"
fi

# Always return success JSON
echo "{}"
exit 0