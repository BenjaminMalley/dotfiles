#!/usr/bin/env python3
import sys
import os
import fcntl
from datetime import datetime

# Standard location for the inbox and log
BASE_DIR = os.path.expanduser("~/.inbox")
INBOX_FILE = os.path.join(BASE_DIR, "active")
LOG_FILE = os.path.join(BASE_DIR, "history.log")

def get_lock(file_handle):
    fcntl.flock(file_handle, fcntl.LOCK_EX)

def release_lock(file_handle):
    fcntl.flock(file_handle, fcntl.LOCK_UN)

def read_file(path):
    if not os.path.exists(path):
        return []
    with open(path, 'r') as f:
        get_lock(f)
        lines = [line.strip() for line in f.readlines() if line.strip()]
        release_lock(f)
    return lines

def write_file(path, lines):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, 'w') as f:
        get_lock(f)
        f.write("\n".join(lines) + "\n")
        release_lock(f)

def cmd_add(session, window, message):
    lines = read_file(INBOX_FILE)
    entry = f"{session}|{window}|{message}"
    lines.append(entry)
    write_file(INBOX_FILE, lines)

def cmd_log(message, title="Notification", context=""):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    log_entry = f"[{timestamp}] {title}: {message}"
    if context:
        log_entry += f" | {context}"
    
    os.makedirs(BASE_DIR, exist_ok=True)
    # Append-only, no internal rotation (handled by newsyslog)
    with open(LOG_FILE, 'a') as f:
        get_lock(f)
        f.write(log_entry + "\n")
        release_lock(f)

def cmd_clear_current(current_session, current_window):
    lines = read_file(INBOX_FILE)
    new_lines = []
    removed = False
    for line in lines:
        parts = line.split('|')
        if len(parts) >= 3:
            s_name, w_idx = parts[0], parts[1]
            if s_name == current_session and str(w_idx) == str(current_window):
                removed = True
                continue
        new_lines.append(line)
    
    if removed:
        write_file(INBOX_FILE, new_lines)

def cmd_check():
    lines = read_file(INBOX_FILE)
    count = len(lines)
    if count > 0:
        print(f"ðŸ“¬ {count}")
    else:
        print("")

def cmd_list():
    lines = read_file(INBOX_FILE)
    if not lines:
        print("No pending tasks.")
        return
    
    print(f"{ 'SESSION':<20} {'WIN':<5} {'MESSAGE'}")
    print("-" * 50)
    for line in lines:
        parts = line.split('|', 2)
        if len(parts) == 3:
            print(f"{parts[0]:<20} {parts[1]:<5} {parts[2]}")
        else:
            print(line)

def main():
    if len(sys.argv) < 2:
        print("Usage: inbox-manager {add|check|clear-current|list|log}")
        sys.exit(1)

    command = sys.argv[1]

    if command == "add":
        if len(sys.argv) < 5:
            sys.exit(1)
        cmd_add(sys.argv[2], sys.argv[3], sys.argv[4])

    elif command == "log":
        message = sys.argv[2] if len(sys.argv) > 2 else "No message"
        title = sys.argv[3] if len(sys.argv) > 3 else "Notification"
        context = sys.argv[4] if len(sys.argv) > 4 else ""
        cmd_log(message, title, context)

    elif command == "check":
        cmd_check()

    elif command == "clear-current":
        if len(sys.argv) < 4:
            sys.exit(1)
        cmd_clear_current(sys.argv[2], sys.argv[3])
        
    elif command == "list":
        cmd_list()

if __name__ == "__main__":
    main()
