#!/usr/bin/env python3
import sys
import os
import fcntl

INBOX_FILE = os.path.expanduser("~/.gemini/inbox")

def get_lock(file_handle):
    fcntl.flock(file_handle, fcntl.LOCK_EX)

def release_lock(file_handle):
    fcntl.flock(file_handle, fcntl.LOCK_UN)

def read_inbox():
    if not os.path.exists(INBOX_FILE):
        return []
    with open(INBOX_FILE, 'r') as f:
        get_lock(f)
        lines = [line.strip() for line in f.readlines() if line.strip()]
        release_lock(f)
    return lines

def write_inbox(lines):
    os.makedirs(os.path.dirname(INBOX_FILE), exist_ok=True)
    with open(INBOX_FILE, 'w') as f:
        get_lock(f)
        f.write("\n".join(lines) + "\n")
        release_lock(f)

def cmd_add(session, window, message):
    lines = read_inbox()
    # Avoid duplicates for the exact same location? 
    # Or just append. Let's just append for now.
    entry = f"{session}|{window}|{message}"
    lines.append(entry)
    write_inbox(lines)

def cmd_clear_current(current_session, current_window):
    lines = read_inbox()
    new_lines = []
    removed = False
    for line in lines:
        parts = line.split('|')
        if len(parts) >= 3:
            s_name, w_idx = parts[0], parts[1]
            if s_name == current_session and str(w_idx) == str(current_window):
                removed = True
                continue
        new_lines.append(line)
    
    if removed:
        write_inbox(new_lines)

def cmd_check():
    lines = read_inbox()
    count = len(lines)
    if count > 0:
        print(f"ðŸ“¬ {count}")
    else:
        print("")

def cmd_list():
    lines = read_inbox()
    if not lines:
        print("No pending tasks.")
        return
    
    print(f"{'SESSION':<20} {'WIN':<5} {'MESSAGE'}")
    print("-" * 50)
    for line in lines:
        parts = line.split('|', 2)
        if len(parts) == 3:
            print(f"{parts[0]:<20} {parts[1]:<5} {parts[2]}")
        else:
            print(line)

def main():
    if len(sys.argv) < 2:
        print("Usage: inbox-manager {add|check|clear-current|list}")
        sys.exit(1)

    command = sys.argv[1]

    if command == "add":
        # Usage: add <session> <window> <message>
        if len(sys.argv) < 5:
            sys.exit(1)
        cmd_add(sys.argv[2], sys.argv[3], sys.argv[4])

    elif command == "check":
        cmd_check()

    elif command == "clear-current":
        # Usage: clear-current <session> <window>
        if len(sys.argv) < 4:
            sys.exit(1)
        cmd_clear_current(sys.argv[2], sys.argv[3])
        
    elif command == "list":
        cmd_list()

if __name__ == "__main__":
    main()
