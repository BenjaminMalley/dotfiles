#!/usr/bin/env python3
"""
Open the DAG URL from oneflow logs.

Searches oneflow logs for the "View the DAG" message and opens the URL in a browser.
Requires DATA_DIR environment variable to be set to the data repo worktree path.

Usage:
    of-dag <job_id>
    of-dag --tail <job_id>  # Wait for URL to appear in live logs
"""

import argparse
import os
import re
import subprocess
import sys


URL_PATTERN = re.compile(r"View the DAG at (https?://\S+)")


def extract_url(text: str) -> str | None:
    """Extract the DAG URL from log text."""
    match = URL_PATTERN.search(text)
    return match.group(1) if match else None


def get_logs(job_id: str) -> str:
    """Get existing logs for a job."""
    try:
        result = subprocess.run(
            ["of", "logs", job_id],
            capture_output=True,
            text=True,
            check=True,
        )
        return result.stdout
    except subprocess.CalledProcessError as e:
        print(f"Error getting logs: {e.stderr}", file=sys.stderr)
        sys.exit(1)
    except FileNotFoundError:
        print("Error: 'of' command not found. Is oneflow installed?", file=sys.stderr)
        sys.exit(1)


def tail_logs(job_id: str) -> str | None:
    """Tail logs until URL is found or process exits."""
    try:
        process = subprocess.Popen(
            ["of", "tail", job_id, "-f"],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
        )

        print(f"Tailing logs for job {job_id}... (Ctrl+C to cancel)", file=sys.stderr)

        for line in process.stdout:
            print(line, end="", file=sys.stderr)
            url = extract_url(line)
            if url:
                process.terminate()
                return url

        process.wait()
        return None
    except KeyboardInterrupt:
        process.terminate()
        print("\nCancelled.", file=sys.stderr)
        sys.exit(0)
    except FileNotFoundError:
        print("Error: 'of' command not found. Is oneflow installed?", file=sys.stderr)
        sys.exit(1)


def open_url(url: str) -> None:
    """Open URL in the default browser."""
    subprocess.run(["open", url], check=True)
    print(f"Opened: {url}")


def main():
    parser = argparse.ArgumentParser(
        description="Open the DAG URL from oneflow logs."
    )
    parser.add_argument("job_id", help="The oneflow job ID")
    parser.add_argument(
        "--tail", "-t",
        action="store_true",
        help="Tail logs and wait for URL to appear"
    )
    parser.add_argument(
        "--print", "-p",
        action="store_true",
        dest="print_only",
        help="Print URL instead of opening it"
    )

    args = parser.parse_args()

    # Check for DATA_DIR if not set
    if "DATA_DIR" not in os.environ:
        print(
            "Warning: DATA_DIR not set. The 'of' command may not work correctly.",
            file=sys.stderr
        )

    # First, check existing logs
    logs = get_logs(args.job_id)
    url = extract_url(logs)

    # If not found and --tail specified, wait for it
    if not url and args.tail:
        url = tail_logs(args.job_id)

    if not url:
        print("No DAG URL found in logs.", file=sys.stderr)
        if not args.tail:
            print("Try running with --tail to wait for the URL.", file=sys.stderr)
        sys.exit(1)

    if args.print_only:
        print(url)
    else:
        open_url(url)


if __name__ == "__main__":
    main()
